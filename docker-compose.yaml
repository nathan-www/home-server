services:

  nextcloud-db:
    image: mariadb:10.6
    restart: always
    command: --transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW
    volumes:
      - /srv/docker_data/nextcloud_db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${NEXTCLOUD_DB_MYSQL_ROOT_PASSWORD}
      - MYSQL_PASSWORD=${NEXTCLOUD_DB_MYSQL_PASSWORD}
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
    networks:
      - nextcloud-net
     
  nextcloud:
    image: nextcloud
    restart: always
    volumes:
      - /srv/docker_data/nextcloud:/var/www/html
    environment:
      - NEXTCLOUD_TRUSTED_DOMAINS=cloud.internal
      - MYSQL_PASSWORD=${NEXTCLOUD_DB_MYSQL_PASSWORD}
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_HOST=nextcloud-db
    extra_hosts:
      - "cloud.internal:127.0.0.1"
    networks:
      - nextcloud-net

  nextcloud-proxy:
    image: caddy:alpine
    restart: always
    volumes:
      - /srv/docker_data/caddy/certs:/certs
      - /srv/docker_data/caddy/config:/config
      - /srv/docker_data/caddy/data:/data
      - /srv/docker_data/caddy/srv:/srv
    ports:
      - 443:443
      - 80:80
    configs:
      - source: Caddyfile
        target: /etc/caddy/Caddyfile
    networks:
      - nextcloud-net

  portainer:
    container_name: portainer
    image: portainer/portainer-ce:2.20.2 # Temporary downgrade due to bug https://github.com/orgs/portainer/discussions/12926
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /srv/docker_data/portainer:/data
    ports:
      - 9443:9443

configs:
  Caddyfile:
    content: |
      https://cloud.internal:443 {
        tls internal
        reverse_proxy nextcloud:80
      }
      http://cloud.internal:80 {
        redir https://cloud.internal{uri}
      }

networks:
  nextcloud-net:
    driver: bridge




